{% extends "base.html" %}
{% block content %}

<section class="search-results-section py-5">
  <div class="container">
    <!-- Search Bar -->
    <div class="search-bar mb-4 d-flex justify-content-center">
      <input
        type="text"
        id="searchKeyword"
        class="form-control w-50 me-2"
        placeholder="Enter keyword..."
      />
      <button id="searchBtn" class="btn btn-primary">Search</button>
    </div>

    <!-- Results Table -->
    <div class="table-responsive shadow rounded">
      <table class="table table-striped align-middle">
        <thead class="table-dark">
          <tr>
            <th scope="col">Display</th>
            <th scope="col">Date</th>
            <th scope="col">Category</th>
            <th scope="col">Description</th>
            <th scope="col">Location</th>
          </tr>
        </thead>
        <tbody id="resultsTableBody">
          <!-- Results will be injected here -->
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container text-center mt-4">
      <nav>
        <ul class="pagination justify-content-center" id="paginationControls">
          <!-- Dynamic pagination links -->
        </ul>
      </nav>
    </div>
  </div>
</section>

{% include "scripts.html" %}
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const searchBtn = document.getElementById("searchBtn");
  const searchKeyword = document.getElementById("searchKeyword");
  const resultsBody = document.getElementById("resultsTableBody");
  const pagination = document.getElementById("paginationControls");

  let currentPage = 1;
  const perPage = 10;

  async function loadResults(page = 1) {
    const keyword = searchKeyword.value.trim();
    const token = localStorage.getItem("authToken");

    const response = await fetch("/api/v1/search", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ keyword, page })
    });

    const data = await response.json();
    resultsBody.innerHTML = "";
    pagination.innerHTML = "";

    if (data.status === "success" && data.results.length > 0) {
      data.results.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><img src="${item.image_url || '/static/images/default.png'}" class="img-thumbnail" width="70"></td>
          <td>${new Date(item.created_at).toLocaleDateString()}</td>
          <td>${item.category}${item.sub_category ? " â†’ " + item.sub_category : ""}</td>
          <td>${item.description || "No description"}</td>
          <td>${item.city || ""}, ${item.state || ""}, ${item.country || ""}</td>
        `;
        resultsBody.appendChild(row);
      });

      // Pagination
      for (let i = 1; i <= data.total_pages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === data.page ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.addEventListener("click", () => {
          currentPage = i;
          loadResults(i);
        });
        pagination.appendChild(li);
      }
    } else {
      resultsBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No results found.</td></tr>`;
    }
  }

  searchBtn.addEventListener("click", () => loadResults());
  loadResults();
});
</script>

{% endblock %}
