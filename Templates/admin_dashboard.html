{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<section class="layout_padding">
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-12 col-md-3 col-lg-2 mb-3 mb-md-0">
        <div class="list-group" id="adminSidebar">
          <button class="list-group-item list-group-item-action active" data-section="users">Users</button>
          <button class="list-group-item list-group-item-action" data-section="items">Items</button>
          <button class="list-group-item list-group-item-action" data-section="testimonials">Testimonials</button>
          <button class="list-group-item list-group-item-action" data-section="email">Send Email</button>
          <a href="/admin/logs" class="list-group-item list-group-item-action">Logs</a>
          <a href="/admin/sales-log" class="list-group-item list-group-item-action">Sales log</a>
          <a href="/admin/logs?level=INFO" class="list-group-item list-group-item-action" data-log-level="INFO">Info Log</a>
          <a href="/admin/logs?level=WARNING" class="list-group-item list-group-item-action" data-log-level="WARNING">Warning Log</a>
          <a href="/admin/logs?level=ERROR" class="list-group-item list-group-item-action" data-log-level="ERROR">Error Log</a>
        </div>
      </div>

      <!-- Main content area -->
      <div class="col-12 col-md-9 col-lg-10">
        <!-- Admin Profile Info -->
        {% if admin_user %}
        <div class="mb-4 p-3" style="background: rgba(255, 255, 255, 0.8); border-radius: 8px; border: 1px solid #ddd;">
          <div class="d-flex align-items-center">
            <div style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 2px solid #ddd; margin-right: 20px; flex-shrink: 0;">
              {% if admin_user.photo and admin_user.photo != 'default.jpg' %}
                <img src="/uploads/{{ admin_user.photo }}" 
                     alt="Admin" 
                     style="width: 100%; height: 100%; object-fit: cover;">
              {% else %}
                <img src="{{ url_for('static', filename='images/default.jpg') }}" 
                     alt="Admin" 
                     style="width: 100%; height: 100%; object-fit: cover;">
              {% endif %}
            </div>
            <div>
              <div style="margin-bottom: 8px;">
                <strong>Username:</strong> {{ admin_user.name or 'N/A' }}
              </div>
              <div>
                <strong>Email:</strong> {{ admin_user.email or 'N/A' }}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <div id="sectionHeader" class="d-flex align-items-center justify-content-between mb-3">
          <h4 class="m-0">Users</h4>
          <div id="sectionActions"></div>
        </div>
        <div id="sectionBody">
          <div class="alert alert-info">Select an action from the sidebar.</div>
        </div>
      </div>
    </div>
  </div>
  
</section>
{% endblock %}

{% block scripts %}
<style>
.admin-table-translucent {
  background-color: rgba(255, 255, 255, 0.8) !important;
}
.admin-table-translucent tbody tr {
  background-color: rgba(255, 255, 255, 0.8) !important;
}
.admin-table-translucent tbody tr:hover {
  background-color: rgba(255, 255, 255, 0.95) !important;
}
</style>
<script>
async function fetchJSON(url, options) {
  const res = await fetch(url, options);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

function setActive(button) {
  document.querySelectorAll('#adminSidebar .list-group-item').forEach(b => b.classList.remove('active'));
  if (button) button.classList.add('active');
}

function renderTable(headers, rows) {
  const thead = `<thead class="table-dark"><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
  const tbody = `<tbody>${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
  return `<div class="table-responsive"><table class="table table-bordered table-hover text-center admin-table-translucent">${thead}${tbody}</table></div>`;
}

async function loadUsers() {
  document.getElementById('sectionHeader').querySelector('h4').textContent = 'Users';
  const actions = document.getElementById('sectionActions');
  actions.innerHTML = `
    <button id="btnAddUser" class="btn btn-primary">Add user</button>
  `;
  document.getElementById('sectionBody').innerHTML = '<div class="alert alert-info">Loading users...</div>';
  try {
    const data = await fetchJSON('/admin/api/users?limit=100');
    const headers = ['Name','Email','Phone','Role','Active','Actions'];
    const rows = (data.items || []).map(u => [
      u.name || '-',
      u.email || '-',
      u.phone || '-',
      u.role || 'user',
      `<span data-user-active="${u.id}">${u.active ? 'Yes' : 'No'}</span>`,
      `<div class="btn-group btn-group-sm" role="group">
         <button class="btn btn-outline-secondary" data-toggle-user="${u.id}">${u.active ? 'Deactivate' : 'Activate'}</button>
         <button class="btn btn-outline-danger" data-del-user="${u.id}">Delete</button>
       </div>`
    ]);
    document.getElementById('sectionBody').innerHTML = renderTable(headers, rows);

    document.querySelectorAll('[data-del-user]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this user?')) return;
        const id = btn.getAttribute('data-del-user');
        await fetch(`/admin/api/users/${id}`, { method: 'DELETE' });
        loadUsers();
      });
    });

    document.querySelectorAll('[data-toggle-user]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-toggle-user');
        try {
          const res = await fetch(`/admin/api/users/${id}/toggle`, { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Toggle failed');
          const cell = document.querySelector(`[data-user-active="${id}"]`);
          if (cell) cell.textContent = data.active ? 'Yes' : 'No';
          btn.textContent = data.active ? 'Deactivate' : 'Activate';
        } catch (e) {
          alert('Failed to toggle user: ' + e.message);
        }
      });
    });

    document.getElementById('btnAddUser').addEventListener('click', () => showAddUserModal());
  } catch (e) {
    document.getElementById('sectionBody').innerHTML = `<div class="alert alert-danger">Failed to load users: ${e.message}</div>`;
  }
}

function showAddUserModal() {
  const name = prompt('Name');
  if (!name) return;
  const email = prompt('Email');
  if (!email) return;
  const phone = prompt('Phone digits');
  const role = prompt('Role (user/admin)', 'user') || 'user';
  const password = prompt('Password (optional, default changeme123)', '') || 'changeme123';
  fetch('/admin/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, phone, role, password })
  }).then(r => r.json()).then(() => loadUsers());
}

async function loadItems() {
  document.getElementById('sectionHeader').querySelector('h4').textContent = 'Items';
  document.getElementById('sectionActions').innerHTML = '';
  document.getElementById('sectionBody').innerHTML = '<div class="alert alert-info">Loading items...</div>';
  try {
    const data = await fetchJSON('/admin/api/items?limit=100');
    const headers = ['Title','Status','Category','Address','Active','Actions'];
    const rows = (data.items || []).map(i => {
      const parts = [i.address, i.city, i.state_province, i.zipcode, i.country].filter(p => p && String(p).trim() !== '');
      const address = parts.join(', ');
      return [
        i.title || '-', i.status || '-', i.category || '-', address || '-',
        `<span data-item-active="${i.id}">${i.is_active ? 'Yes' : 'No'}</span>`,
      `<div class="btn-group btn-group-sm" role="group">
         <button class="btn btn-outline-secondary" data-toggle-item="${i.id}">${i.is_active ? 'Deactivate' : 'Activate'}</button>
         <button class="btn btn-outline-danger" data-del-item="${i.id}">Delete</button>
       </div>`
      ];
    });
    document.getElementById('sectionBody').innerHTML = renderTable(headers, rows);
    document.querySelectorAll('[data-del-item]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this item?')) return;
        const id = btn.getAttribute('data-del-item');
        await fetch(`/admin/api/items/${id}`, { method: 'DELETE' });
        loadItems();
      });
    });

    document.querySelectorAll('[data-toggle-item]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-toggle-item');
        try {
          const res = await fetch(`/admin/api/items/${id}/toggle`, { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Toggle failed');
          const cell = document.querySelector(`[data-item-active="${id}"]`);
          if (cell) cell.textContent = data.is_active ? 'Yes' : 'No';
          btn.textContent = data.is_active ? 'Deactivate' : 'Activate';
        } catch (e) {
          alert('Failed to toggle item: ' + e.message);
        }
      });
    });
  } catch (e) {
    document.getElementById('sectionBody').innerHTML = `<div class="alert alert-danger">Failed to load items: ${e.message}</div>`;
  }
}

async function loadTestimonials() {
  document.getElementById('sectionHeader').querySelector('h4').textContent = 'Testimonials';
  document.getElementById('sectionActions').innerHTML = '';
  document.getElementById('sectionBody').innerHTML = '<div class="alert alert-info">Loading testimonials...</div>';
  try {
    const data = await fetchJSON('/admin/api/testimonials?limit=100');
    const headers = ['User','Message','Public','Actions'];
    const rows = (data.items || []).map(t => [
      t.user_name || '-', t.message || '-', `<span data-t-public="${t.id}">${t.is_public ? 'Yes' : 'No'}</span>`,
      `<div class="btn-group btn-group-sm" role="group">
         <button class="btn btn-outline-secondary" data-toggle-t="${t.id}">${t.is_public ? 'Unpublish' : 'Publish'}</button>
         <button class="btn btn-outline-danger" data-del-t="${t.id}">Delete</button>
       </div>`
    ]);
    document.getElementById('sectionBody').innerHTML = renderTable(headers, rows);
    document.querySelectorAll('[data-del-t]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this testimonial?')) return;
        const id = btn.getAttribute('data-del-t');
        await fetch(`/admin/api/testimonials/${id}`, { method: 'DELETE' });
        loadTestimonials();
      });
    });

    document.querySelectorAll('[data-toggle-t]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-toggle-t');
        try {
          const res = await fetch(`/admin/api/testimonials/${id}/toggle`, { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Toggle failed');
          const cell = document.querySelector(`[data-t-public="${id}"]`);
          if (cell) cell.textContent = data.is_public ? 'Yes' : 'No';
          btn.textContent = data.is_public ? 'Unpublish' : 'Publish';
        } catch (e) {
          alert('Failed to toggle testimonial: ' + e.message);
        }
      });
    });
  } catch (e) {
    document.getElementById('sectionBody').innerHTML = `<div class="alert alert-danger">Failed to load testimonials: ${e.message}</div>`;
  }
}

function loadEmailForm() {
  document.getElementById('sectionHeader').querySelector('h4').textContent = 'Send Email';
  document.getElementById('sectionActions').innerHTML = '';
  document.getElementById('sectionBody').innerHTML = `
    <div class="card">
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">To</label>
          <input id="emailTo" class="form-control" placeholder="user@example.com" />
        </div>
        <div class="mb-3">
          <label class="form-label">Subject</label>
          <input id="emailSubject" class="form-control" placeholder="Subject" />
        </div>
        <div class="mb-3">
          <label class="form-label">Body</label>
          <textarea id="emailBody" class="form-control" rows="6" placeholder="Message"></textarea>
        </div>
        <button id="sendEmailBtn" class="btn btn-primary">Send</button>
        <div id="emailStatus" class="mt-3"></div>
      </div>
    </div>`;
  document.getElementById('sendEmailBtn').addEventListener('click', async () => {
    const to = document.getElementById('emailTo').value.trim();
    const subject = document.getElementById('emailSubject').value.trim();
    const body = document.getElementById('emailBody').value.trim();
    const status = document.getElementById('emailStatus');
    status.innerHTML = '<div class="text-info">Sending...</div>';
    try {
      await fetch('/admin/api/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to, subject, body })
      });
      status.innerHTML = '<div class="text-success">Sent (check SMTP debug server)</div>';
    } catch (e) {
      status.innerHTML = `<div class="text-danger">Failed: ${e.message}</div>`;
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  // Default load users
  loadUsers();

  document.querySelectorAll('#adminSidebar .list-group-item').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const section = btn.getAttribute('data-section');
      // Intercept only the specific level links; allow generic Logs to navigate normally
      const levelAttr = btn.getAttribute('data-log-level');
      if (!section && levelAttr) {
        e.preventDefault();
        setActive(btn);
        return loadLogs(levelAttr.toUpperCase());
      }
      if (!section) return; // allow navigation for anchors without data-section/data-log-level
      setActive(btn);
      if (section === 'users') return loadUsers();
      if (section === 'items') return loadItems();
      if (section === 'testimonials') return loadTestimonials();
      if (section === 'email') return loadEmailForm();
    });
  });

  async function loadLogs(level) {
    const title = 'Logs' + (level ? ` - ${level}` : '');
    document.getElementById('sectionHeader').querySelector('h4').textContent = title;
    const actions = document.getElementById('sectionActions');
    actions.innerHTML = `
      <div class="d-flex gap-2">
        <select id="logDays" class="form-select form-select-sm" style="width:auto">
          <option value="1">1d</option>
          <option value="3">3d</option>
          <option value="7" selected>7d</option>
          <option value="14">14d</option>
          <option value="30">30d</option>
        </select>
        <button id="logRefresh" class="btn btn-sm btn-outline-primary">Refresh</button>
        <div class="form-check ms-2">
          <input class="form-check-input" type="checkbox" id="logWrap">
          <label class="form-check-label" for="logWrap">Wrap</label>
        </div>
      </div>
    `;
    const body = document.getElementById('sectionBody');
    body.innerHTML = `
      <div class="card">
        <div class="card-body" style="padding:0;">
          <pre id="logPre" style="margin:0;padding:16px;background:#0f172a;color:#e2e8f0;height:60vh;overflow:auto;white-space:pre;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">Loading...</pre>
        </div>
      </div>
    `;

    async function fetchAndRender() {
      const days = document.getElementById('logDays').value;
      const wrap = document.getElementById('logWrap').checked;
      const qs = new URLSearchParams({ days, order: 'desc', limit: '2000' });
      if (level) qs.set('level', level);
      try {
        const res = await fetch(`/admin/logs/text?${qs.toString()}`);
        const payload = await res.json();
        const pre = document.getElementById('logPre');
        const lines = (payload && payload.lines) ? payload.lines : [];
        pre.style.whiteSpace = wrap ? 'pre-wrap' : 'pre';
        pre.textContent = lines.length ? lines.join('\n') : 'No matching log lines.';
      } catch (e) {
        document.getElementById('logPre').textContent = `Error: ${e.message}`;
      }
    }

    document.getElementById('logRefresh').addEventListener('click', fetchAndRender);
    document.getElementById('logWrap').addEventListener('change', fetchAndRender);
    fetchAndRender();
  }
});
</script>
{% endblock %}


