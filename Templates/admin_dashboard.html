{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<section class="layout_padding">
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-12 col-md-3 col-lg-2 mb-3 mb-md-0">
        <div class="list-group" id="adminSidebar">
          <button class="list-group-item list-group-item-action active" data-section="users">Users</button>
          <button class="list-group-item list-group-item-action" data-section="items">Items</button>
          <button class="list-group-item list-group-item-action" data-section="testimonials">Testimonials</button>
          <button class="list-group-item list-group-item-action" data-section="email">Send Email</button>
          <a href="/admin/logs" class="list-group-item list-group-item-action">Logs</a>
        </div>
      </div>

      <!-- Main content area -->
      <div class="col-12 col-md-9 col-lg-10">
        <div id="sectionHeader" class="d-flex align-items-center justify-content-between mb-3">
          <h4 class="m-0">Users</h4>
          <div id="sectionActions"></div>
        </div>
        <div id="sectionBody">
          <div class="alert alert-info">Select an action from the sidebar.</div>
        </div>
      </div>
    </div>
  </div>
  
</section>
{% endblock %}

{% block scripts %}
<script>
async function fetchJSON(url, options) {
  const res = await fetch(url, options);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

function setActive(button) {
  document.querySelectorAll('#adminSidebar .list-group-item').forEach(b => b.classList.remove('active'));
  if (button) button.classList.add('active');
}

function renderTable(headers, rows) {
  const thead = `<thead class="table-dark"><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
  const tbody = `<tbody>${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
  return `<div class="table-responsive"><table class="table table-bordered table-hover text-center">${thead}${tbody}</table></div>`;
}

async function loadUsers() {
  document.getElementById('sectionHeader').querySelector('h4').textContent = 'Users';
  const actions = document.getElementById('sectionActions');
  actions.innerHTML = `
    <button id="btnAddUser" class="btn btn-primary">Add user</button>
  `;
  document.getElementById('sectionBody').innerHTML = '<div class="alert alert-info">Loading users...</div>';
  try {
    const data = await fetchJSON('/admin/api/users?limit=100');
    const headers = ['Name','Email','Phone','Role','Active','Actions'];
    const rows = (data.items || []).map(u => [
      u.name || '-',
      u.email || '-',
      u.phone || '-',
      u.role || 'user',
      u.active ? 'Yes' : 'No',
      `<button class="btn btn-sm btn-outline-danger" data-del-user="${u.id}">Delete</button>`
    ]);
    document.getElementById('sectionBody').innerHTML = renderTable(headers, rows);

    document.querySelectorAll('[data-del-user]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this user?')) return;
        const id = btn.getAttribute('data-del-user');
        await fetch(`/admin/api/users/${id}`, { method: 'DELETE' });
        loadUsers();
      });
    });

    document.getElementById('btnAddUser').addEventListener('click', () => showAddUserModal());
  } catch (e) {
    document.getElementById('sectionBody').innerHTML = `<div class="alert alert-danger">Failed to load users: ${e.message}</div>`;
  }
}

function showAddUserModal() {
  const name = prompt('Name');
  if (!name) return;
  const email = prompt('Email');
  if (!email) return;
  const phone = prompt('Phone digits');
  const role = prompt('Role (user/admin)', 'user') || 'user';
  const password = prompt('Password (optional, default changeme123)', '') || 'changeme123';
  fetch('/admin/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, phone, role, password })
  }).then(r => r.json()).then(() => loadUsers());
}

async function loadItems() {
  document.getElementById('sectionHeader').querySelector('h4').textContent = 'Items';
  document.getElementById('sectionActions').innerHTML = '';
  document.getElementById('sectionBody').innerHTML = '<div class="alert alert-info">Loading items...</div>';
  try {
    const data = await fetchJSON('/admin/api/items?limit=100');
    const headers = ['Title','Status','Category','City','Active','Actions'];
    const rows = (data.items || []).map(i => [
      i.title || '-', i.status || '-', i.category || '-', i.city || '-', i.is_active ? 'Yes' : 'No',
      `<button class="btn btn-sm btn-outline-danger" data-del-item="${i.id}">Delete</button>`
    ]);
    document.getElementById('sectionBody').innerHTML = renderTable(headers, rows);
    document.querySelectorAll('[data-del-item]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this item?')) return;
        const id = btn.getAttribute('data-del-item');
        await fetch(`/admin/api/items/${id}`, { method: 'DELETE' });
        loadItems();
      });
    });
  } catch (e) {
    document.getElementById('sectionBody').innerHTML = `<div class="alert alert-danger">Failed to load items: ${e.message}</div>`;
  }
}

async function loadTestimonials() {
  document.getElementById('sectionHeader').querySelector('h4').textContent = 'Testimonials';
  document.getElementById('sectionActions').innerHTML = '';
  document.getElementById('sectionBody').innerHTML = '<div class="alert alert-info">Loading testimonials...</div>';
  try {
    const data = await fetchJSON('/admin/api/testimonials?limit=100');
    const headers = ['User','Message','Public','Actions'];
    const rows = (data.items || []).map(t => [
      t.user_name || '-', t.message || '-', t.is_public ? 'Yes' : 'No',
      `<button class="btn btn-sm btn-outline-danger" data-del-t="${t.id}">Delete</button>`
    ]);
    document.getElementById('sectionBody').innerHTML = renderTable(headers, rows);
    document.querySelectorAll('[data-del-t]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this testimonial?')) return;
        const id = btn.getAttribute('data-del-t');
        await fetch(`/admin/api/testimonials/${id}`, { method: 'DELETE' });
        loadTestimonials();
      });
    });
  } catch (e) {
    document.getElementById('sectionBody').innerHTML = `<div class="alert alert-danger">Failed to load testimonials: ${e.message}</div>`;
  }
}

function loadEmailForm() {
  document.getElementById('sectionHeader').querySelector('h4').textContent = 'Send Email';
  document.getElementById('sectionActions').innerHTML = '';
  document.getElementById('sectionBody').innerHTML = `
    <div class="card">
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">To</label>
          <input id="emailTo" class="form-control" placeholder="user@example.com" />
        </div>
        <div class="mb-3">
          <label class="form-label">Subject</label>
          <input id="emailSubject" class="form-control" placeholder="Subject" />
        </div>
        <div class="mb-3">
          <label class="form-label">Body</label>
          <textarea id="emailBody" class="form-control" rows="6" placeholder="Message"></textarea>
        </div>
        <button id="sendEmailBtn" class="btn btn-primary">Send</button>
        <div id="emailStatus" class="mt-3"></div>
      </div>
    </div>`;
  document.getElementById('sendEmailBtn').addEventListener('click', async () => {
    const to = document.getElementById('emailTo').value.trim();
    const subject = document.getElementById('emailSubject').value.trim();
    const body = document.getElementById('emailBody').value.trim();
    const status = document.getElementById('emailStatus');
    status.innerHTML = '<div class="text-info">Sending...</div>';
    try {
      await fetch('/admin/api/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to, subject, body })
      });
      status.innerHTML = '<div class="text-success">Sent (check SMTP debug server)</div>';
    } catch (e) {
      status.innerHTML = `<div class="text-danger">Failed: ${e.message}</div>`;
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  // Default load users
  loadUsers();

  document.querySelectorAll('#adminSidebar .list-group-item').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const section = btn.getAttribute('data-section');
      if (!section) return; // logs link
      setActive(btn);
      if (section === 'users') return loadUsers();
      if (section === 'items') return loadItems();
      if (section === 'testimonials') return loadTestimonials();
      if (section === 'email') return loadEmailForm();
    });
  });
});
</script>
{% endblock %}


